# Edit History — 2026-02-28

## Summary

Four major sessions today:

1. **AI Architecture Pivot** — Replaced OpenClaw agent forwarding with direct Anthropic API integration (tool calling pattern). agentForwarder.js now calls Claude directly, executes DB operations via tool executor, and replies via Feishu API without any relay.

2. **Code Review + Bug Fixes** — Full review of all server-side code; fixed security issue, edge cases, and code quality problems.

3. **Feishu OAuth Login + Per-Agent API Keys** — Replaced insecure client-side password auth with server-side Feishu OAuth SSO + JWT session cookies. Added DB-backed API key management.

4. **Code Review Hardening** — Two rounds of comprehensive code review identifying and fixing 4 critical + 8 warning + 7 suggestion issues across the auth/API key feature.

---

## AI Architecture: Direct Anthropic Tool Calling

### What Changed
- **`agentForwarder.js`** — Complete rewrite. No longer POSTs to `AGENT_WEBHOOK_URL`. Now:
  - Calls Anthropic API directly (`claude-haiku-4-5-20251001`)
  - Provides 3 tools: `list_tasks`, `create_task`, `complete_task`
  - Runs agentic loop (max 5 rounds) until `stop_reason = end_turn`
  - Persists conversation history in PostgreSQL (`conversation_history` table, 20 msgs/chat)
  - Builds system prompt with current date, user context, registered users list, and tool rules
  - Calls `feishu.sendMessage()` directly to reply
- **`AGENT_WEBHOOK_URL`** — No longer used; can be removed from `.env`
- **New env var**: `ANTHROPIC_API_KEY` (required for AI features)

### Why
- OpenClaw agent tool restriction (`tools.allow`) doesn't work for non-sandbox sessions
- Docker sandbox was blocked by systemd user service + docker GID issue
- Direct Anthropic API is more controllable and engineering-friendly

---

## Code Review Fixes (Session 1 — earlier today)

### Security
- **`agentForwarder.js`**: Added `complete_task` ownership check — users can only complete tasks assigned to themselves via chat. Queries DB before calling `completeTask()`, verifies `assignee_open_id` or `assignee_id` matches caller.

### Bug Fixes
- **`agentForwarder.js`**: Added fallback message when agentic loop exits with no text (e.g. `MAX_TOOL_ROUNDS` hit mid-tool-call) — previously silently dropped the request
- **`webhook.js`**: Added guard to skip AI forwarding when `messageText` is empty (non-text message types, parse failures) — prevented sending empty strings to Anthropic
- **`agentForwarder.js`**: Fixed `getAgentConfig()` — was returning `{ model }` but caller checked `config?.webhookUrl` → always `false`; now returns `{ model, maxHistoryMessages, maxToolRounds }`
- **`agent.js`** `/status`: Fixed `webhook_configured` field that was always `false` — replaced with actual config fields
- **`agent.js`** `/schema`: Removed references to `agentForwarder.BRIDGE_VERSION` and `CAPABILITIES` which were never exported (returned `undefined`)

### Code Quality
- **`users.js`** `list()`: Fixed `LIMIT $${idx++} OFFSET $${idx}` — relied on side-effect evaluation order; now explicit `limitIdx`/`offsetIdx`
- **`db/index.js`** `audit.list()`: Same `idx++` fix
- **`intentDetector.js`**: Added order-dependency comment — cuiban patterns must precede short-message greeting fallback
- **`cuibanHandler.js`**: Documented deliberate minimal session task shape `{ id, title }`
- **`feishu/client.js`**: Clarified reply-mode comment in `sendMessage`

---

## Comprehensive Code Review Fixes (Session 2)

Full codebase code review followed by "fix all" — 12 tracked issues resolved.

### Critical Fixes

1. **Singleton Anthropic client** (`agentForwarder.js`) — Replaced per-request `new Anthropic()` with lazy singleton `getClient()`. Avoids redundant object allocation and makes API key changes require a restart (acceptable trade-off).

2. **Migration for `conversation_history`** — Moved runtime DDL (`ensureConversationHistory`) from `db/index.js` + `index.js` startup into proper migration file `db/migrations/008_add_conversation_history.sql`. Removed the auto-DDL code path entirely.

3. **Atomic history pruning** (`agentForwarder.js`) — Replaced separate `INSERT` + `DELETE` with a single CTE query to prevent race conditions when concurrent messages arrive for the same chat.

4. **Concurrency backpressure** (`agentForwarder.js`) — Added semaphore pattern (`MAX_CONCURRENT_AGENTS=10`) with `acquireSlot()`/`releaseSlot()` wrapped in `try/finally` to prevent unbounded Anthropic API calls under load.

### Security Fixes

5. **Removed deprecated `requireAdmin`** (`auth.js`) — Deleted the function that read forgeable `x-user-id`/`x-user-email` headers. Removed from exports and tests.

6. **Agent task completion ownership check** (`agent.js`) — Added DB query to verify that `user_open_id` matches the task's `assignee_open_id` or `assignee_id` before allowing completion via `/api/agent/tasks/:id/complete`. Returns 403 on mismatch.

### Bug Fixes

7. **SQL interval injection** (`reminder.js`) — Replaced string concatenation `(reminder_interval_hours || ' hours')::interval` with parameterized `make_interval(hours => reminder_interval_hours)`.

8. **Field component prop injection** (`web/users/page.tsx`) — Replaced broken object spread `{...children, props: {id}}` with `React.cloneElement(children, { id })`.

9. **Dashboard `builtinEnabled`** (`api.js`) — Added missing `builtinEnabled` field to `/api/dashboard` response (was computed but not returned).

10. **`validateEnv.js`** — Replaced stale `AGENT_WEBHOOK_URL` references with `ANTHROPIC_API_KEY` in optional vars list and warning messages.

### Code Quality

11. **Batch rate limiter eviction** (`rateLimit.js`) — Changed single-entry eviction to batch ~10% eviction when hitting the 10k cap, reducing O(n) worst-case churn.

12. **Documentation comments** — Token expiry safety margin in `feishu/client.js`; `resolveActor` TODO in `api.js` noting client-provided userId is trusted pre-auth.

### Test Updates

- Removed `requireAdmin` test block from `auth.test.js`
- Updated `agent.test.js` mock for `agentForwarder` (new export shape)
- Rewrote `agentForwarder.test.js` — replaced stale OpenClaw-era tests (`formatForAgent`, `generateSignature`, `forwardToAgent`, `BRIDGE_VERSION`, `CAPABILITIES`) with tests for current exports (`isAgentConfigured`, `getAgentConfig`, `forwardToOwnerAgent`)

---

## Documentation Updates

### Session 1
- `docs/architecture.md` — Updated main arch diagram, added AI agent section with tool descriptions, added `conversation_history` DB schema, updated env vars
- `docs/api.md` — Rewrote `/api/agent/*` section: updated `/status` response, added `/tasks` (GET/POST/complete) endpoints, updated Feishu bot command reference with AI natural language examples
- `CLAUDE.md` — Updated request flow diagram and `agentForwarder.js` module description
- `docs/edit-history/2026-02-28.md` — This file

### Session 2
- `docs/architecture.md` — Removed `requireAdmin` reference from auth.js description; updated `conversation_history` note about migration; added concurrency semaphore to agentForwarder description; updated migration list with 008
- `docs/api.md` — Added 403 error for agent task completion ownership check; added `builtinEnabled` to dashboard response
- `docs/setup-openclaw.md` — Added deprecation notice (OpenClaw integration replaced by direct Anthropic API)
- `docs/troubleshooting.md` — Updated OpenClaw references with Anthropic context
- `CLAUDE.md` — Updated auth.js description (removed `requireAdmin`); updated migration count; updated `agentForwarder.js` description with concurrency semaphore

---

## Feishu OAuth Login + Per-Agent API Keys (Session 3)

Replaced insecure client-side password auth with server-side Feishu OAuth SSO + JWT session cookies. Added DB-backed API key management for agent authentication.

### Authentication Overhaul

**Problem:** Admin panel used `NEXT_PUBLIC_ADMIN_PASSWORD` stored in the JS bundle with a boolean in localStorage — trivially bypassable via DevTools.

**Solution:**
1. **Feishu OAuth SSO** (primary login) — `/api/auth/feishu` redirects to Feishu authorize → callback exchanges code → auto-provisions user → sets JWT httpOnly cookie (`rlk_session`, 7d expiry)
2. **Password login** (fallback) — moved server-side; `POST /api/auth/password` validates `ADMIN_PASSWORD` env var via SHA-256 timingSafeEqual
3. **JWT session middleware** (`sessionAuth`) — checks cookie first, falls back to legacy API_KEY header for backward compatibility
4. **CSRF protection** — OAuth flow uses random state cookie verified on callback

### Per-Agent API Key Management

**Problem:** Single shared `AGENT_API_KEY` env var for all agent integrations — no way to rotate or audit per-integration.

**Solution:**
- New `agent_api_keys` table — stores SHA-256 hash, prefix for display, creator, timestamps
- Raw key (`rlk_` + 32 hex chars) returned once at creation, only hash stored
- `agentAuth` middleware: checks env var first → DB key lookup as fallback
- Admin UI at `/api-keys` — create, view, copy (one-time), revoke
- `last_used_at` updated fire-and-forget on each use
- Soft-revoke (sets `revoked_at`, doesn't delete)

### New Files
- `db/migrations/009_add_auth_tables.sql` — `agent_api_keys` table + `users.avatar_url` column
- `packages/server/src/utils/jwt.js` — JWT sign/verify, cookie config, dev fallback random secret
- `packages/server/src/db/apiKeys.js` — API key CRUD (create, findByHash, list, revoke, touchLastUsed)
- `packages/server/src/routes/auth.js` — OAuth flow, password login, `/me`, `/logout`
- `packages/server/src/routes/apiKeys.js` — API key list/create/revoke endpoints
- `packages/web/src/app/api-keys/page.tsx` — API key management page (table + create form + copy card)

### Modified Files
- `packages/server/src/middleware/auth.js` — New `sessionAuth` (JWT + legacy API key); updated `agentAuth` (env var + DB key); `apiAuth` → alias for `sessionAuth`
- `packages/server/src/index.js` — Added cookie-parser, auth routes, API key routes, CORS credentials, sessionAuth
- `packages/server/src/routes/api.js` — `resolveActor()` prefers `req.user.sub` from JWT session (fixes audit log impersonation)
- `packages/server/src/utils/validateEnv.js` — Added JWT_SECRET/ADMIN_PASSWORD/FEISHU_OAUTH_REDIRECT_URI; JWT_SECRET required in production
- `packages/web/src/lib/auth.tsx` — Complete rewrite: server-side JWT sessions, Feishu OAuth primary, password collapsible fallback
- `packages/web/src/lib/api.ts` — Removed API key header, added `credentials: 'include'`, 401 auto-reload, AgentApiKey type + methods
- `packages/web/src/app/NavBar.tsx` — User avatar/name display, API Keys nav link (admin-gated)
- `docker-compose.yml` — Added JWT_SECRET/ADMIN_PASSWORD/FEISHU_OAUTH_REDIRECT_URI; removed NEXT_PUBLIC build args; API_KEY now optional
- `.env.example` — Restructured for new auth vars, deprecated NEXT_PUBLIC_* vars
- `db/init.sql` — Appended agent_api_keys table + avatar_url column

### Dependencies Added
- `jsonwebtoken@^9.0.2` — JWT signing/verification
- `cookie-parser@^1.4.6` — Cookie middleware for Express

### Environment Variables
| Variable | Required | Description |
|---|---|---|
| `JWT_SECRET` | Production | 32+ byte random secret for JWT signing |
| `ADMIN_PASSWORD` | No | Server-side password for fallback login |
| `FEISHU_OAUTH_REDIRECT_URI` | For OAuth | Full callback URL |

**Deprecated:** `NEXT_PUBLIC_ADMIN_PASSWORD`, `NEXT_PUBLIC_API_KEY` (backward compat kept)

### Test Updates
- `packages/server/tests/auth.test.js` — Rewritten for `sessionAuth`/`agentAuth`; added JWT mock, DB API key mock, agentAuth tests
- `packages/web/tests/components.test.tsx` — Added `useAuth` mock for server-side auth; updated dashboard mock data

### Documentation Updates
- `CLAUDE.md` — Updated auth description, migration count, module list, database description
- `docs/architecture.md` — Added auth routes/modules, agent_api_keys schema, updated security table, deployment env vars
- `docs/api.md` — Added auth endpoints section, API key management section, updated auth description
- `docs/edit-history/2026-02-28.md` — This session

---

## Code Review Hardening (Sessions 4 & 5)

Two rounds of comprehensive code review on the auth/API key feature, identifying and fixing all issues.

### Critical Fixes (Round 1)

1. **Role-based authorization on API key routes** (`apiKeys.js`) — Added `router.use()` middleware requiring admin/superadmin role; returns 403 for non-admin users. Previously any authenticated user could create/revoke keys.

2. **`req.user` for legacy API key path** (`auth.js`) — `sessionAuth` legacy API key check now sets `req.user = LEGACY_API_KEY_USER` (frozen constant with `sub: 'api_key_user', role: 'superadmin'`). Previously `req.user` was `undefined`, causing downstream `TypeError` on `req.user.sub`.

3. **Server-side rate limiting on password login** (`auth.js`) — Added `passwordRateLimit` (5 attempts/IP/minute) using existing `rateLimit` factory. Prevents brute-force even when client-side lockout is bypassed.

4. **JWT algorithm whitelist** (`jwt.js`) — Added `{ algorithms: ['HS256'] }` to `jwt.verify()` to prevent algorithm confusion attacks.

### Security Fixes (Round 2)

5. **CSRF state constant-time comparison** (`auth.js`) — Replaced `!==` with `crypto.timingSafeEqual(Buffer.from(state), Buffer.from(savedState))` + length check.

6. **Fetch timeout on OAuth API calls** (`auth.js`) — Added `AbortSignal.timeout(10_000)` to Feishu token exchange and user info `fetch()` calls. Prevents hung connections.

### Bug Fixes

7. **Bare catch hides DB error** (`auth.js`) — Password login `catch` block now logs via `logger.warn` instead of silently swallowing.

8. **`touchLastUsed` silent error** (`auth.js` middleware) — Changed `.catch(() => {})` to `.catch(err => logger.debug(...))`.

### Code Quality

9. **Inline SQL moved to usersDb** (`auth.js`, `users.js`) — Added `usersDb.updateAvatar(userId, avatarUrl)` method; replaced inline `pool.query` in OAuth callback.

10. **Duplicated `req.user` literal** (`auth.js`) — Extracted `LEGACY_API_KEY_USER = Object.freeze(...)` constant.

11. **Duplicated LoadingState/ErrorState** (`api-keys/page.tsx`) — Replaced local copies with import from `@/components/StatusStates`.

12. **403 handling in API keys page** (`api-keys/page.tsx`) — Detects 403/Forbidden errors and shows "无权访问：需要管理员权限" without retry button.

13. **201 status for key creation** (`apiKeys.js`) — Changed `res.json()` to `res.status(201).json()`.

14. **JWT stale data documented** (`auth.js`) — Added comment noting role/name/avatar embedded in 7-day JWT remain stale until re-login.

### Accessibility (a11y)

15. **Loading spinner ARIA** (`auth.tsx`) — Added `role="status"` and `aria-hidden="true"` on spinner.

16. **Avatar alt text** (`NavBar.tsx`) — Changed `alt=""` to `alt={user.name || 'Avatar'}`.

17. **Revoke button labels** (`api-keys/page.tsx`) — Added `aria-label={`撤销 ${apiKey.name}`}` to distinguish buttons for screen readers.

18. **Form input labels** (`auth.tsx`, `api-keys/page.tsx`) — Added `aria-label="密码"` and `aria-label="Key 名称"` to inputs using placeholder-only pattern.

### Test Updates

- `auth.test.js` — Updated 3 legacy API key tests to assert `req.user` fields (`req.user.sub`, `req.user.role`)

### Files Modified

**Server:**
- `packages/server/src/utils/jwt.js` — algorithms whitelist
- `packages/server/src/middleware/auth.js` — `LEGACY_API_KEY_USER` constant, `req.user` on legacy path, `touchLastUsed` debug log
- `packages/server/src/routes/auth.js` — rate limiting, CSRF constant-time, fetch timeout, usersDb.updateAvatar, bare catch logging, JWT stale data comment
- `packages/server/src/routes/apiKeys.js` — role gate middleware, 201 status
- `packages/server/src/db/users.js` — `updateAvatar()` method
- `packages/server/tests/auth.test.js` — `req.user` assertions

**Web:**
- `packages/web/src/lib/auth.tsx` — spinner ARIA, password input aria-label
- `packages/web/src/app/api-keys/page.tsx` — shared StatusStates import, 403 handling, revoke aria-labels, key name aria-label
- `packages/web/src/app/NavBar.tsx` — avatar alt text

---

## Files Modified (Sessions 1 & 2)

### Server
- `packages/server/src/services/agentForwarder.js` — Full rewrite (Anthropic tool calling) + singleton client + atomic CTE pruning + concurrency semaphore
- `packages/server/src/routes/webhook.js` — Empty text guard
- `packages/server/src/routes/agent.js` — Status/schema endpoint fixes + ownership check on task completion
- `packages/server/src/routes/api.js` — Dashboard `builtinEnabled` + `resolveActor` TODO
- `packages/server/src/db/users.js` — `list()` idx fix
- `packages/server/src/db/index.js` — `audit.list()` idx fix + removed `ensureConversationHistory`
- `packages/server/src/index.js` — Removed `ensureConversationHistory` startup call
- `packages/server/src/middleware/auth.js` — Removed deprecated `requireAdmin`
- `packages/server/src/middleware/rateLimit.js` — Batch eviction (~10%)
- `packages/server/src/services/reminder.js` — `make_interval` fix
- `packages/server/src/utils/validateEnv.js` — ANTHROPIC_API_KEY references
- `packages/server/src/utils/intentDetector.js` — Order comment
- `packages/server/src/services/cuibanHandler.js` — Session shape comment
- `packages/server/src/feishu/client.js` — Token expiry comment + reply mode comment

### Web
- `packages/web/src/app/users/page.tsx` — `cloneElement` fix for Field component

### Tests
- `packages/server/tests/auth.test.js` — Removed `requireAdmin` block
- `packages/server/tests/agent.test.js` — Updated mock + assertions for new API shape
- `packages/server/tests/agentForwarder.test.js` — Full rewrite for current exports

### Database
- `db/migrations/008_add_conversation_history.sql` — New migration (moved from runtime DDL)

### Docs
- `docs/architecture.md`
- `docs/api.md`
- `docs/setup-openclaw.md`
- `docs/troubleshooting.md`
- `CLAUDE.md`
