# Edit History — 2026-02-28

## Summary

Two major sessions today:

1. **AI Architecture Pivot** — Replaced OpenClaw agent forwarding with direct Anthropic API integration (tool calling pattern). agentForwarder.js now calls Claude directly, executes DB operations via tool executor, and replies via Feishu API without any relay.

2. **Code Review + Bug Fixes** — Full review of all server-side code; fixed security issue, edge cases, and code quality problems.

---

## AI Architecture: Direct Anthropic Tool Calling

### What Changed
- **`agentForwarder.js`** — Complete rewrite. No longer POSTs to `AGENT_WEBHOOK_URL`. Now:
  - Calls Anthropic API directly (`claude-haiku-4-5-20251001`)
  - Provides 3 tools: `list_tasks`, `create_task`, `complete_task`
  - Runs agentic loop (max 5 rounds) until `stop_reason = end_turn`
  - Persists conversation history in PostgreSQL (`conversation_history` table, 20 msgs/chat)
  - Builds system prompt with current date, user context, registered users list, and tool rules
  - Calls `feishu.sendMessage()` directly to reply
- **`AGENT_WEBHOOK_URL`** — No longer used; can be removed from `.env`
- **New env var**: `ANTHROPIC_API_KEY` (required for AI features)

### Why
- OpenClaw agent tool restriction (`tools.allow`) doesn't work for non-sandbox sessions
- Docker sandbox was blocked by systemd user service + docker GID issue
- Direct Anthropic API is more controllable and engineering-friendly

---

## Code Review Fixes

### Security
- **`agentForwarder.js`**: Added `complete_task` ownership check — users can only complete tasks assigned to themselves via chat. Queries DB before calling `completeTask()`, verifies `assignee_open_id` or `assignee_id` matches caller.

### Bug Fixes
- **`agentForwarder.js`**: Added fallback message when agentic loop exits with no text (e.g. `MAX_TOOL_ROUNDS` hit mid-tool-call) — previously silently dropped the request
- **`webhook.js`**: Added guard to skip AI forwarding when `messageText` is empty (non-text message types, parse failures) — prevented sending empty strings to Anthropic
- **`agentForwarder.js`**: Fixed `getAgentConfig()` — was returning `{ model }` but caller checked `config?.webhookUrl` → always `false`; now returns `{ model, maxHistoryMessages, maxToolRounds }`
- **`agent.js`** `/status`: Fixed `webhook_configured` field that was always `false` — replaced with actual config fields
- **`agent.js`** `/schema`: Removed references to `agentForwarder.BRIDGE_VERSION` and `CAPABILITIES` which were never exported (returned `undefined`)

### Code Quality
- **`users.js`** `list()`: Fixed `LIMIT $${idx++} OFFSET $${idx}` — relied on side-effect evaluation order; now explicit `limitIdx`/`offsetIdx`
- **`db/index.js`** `audit.list()`: Same `idx++` fix
- **`intentDetector.js`**: Added order-dependency comment — cuiban patterns must precede short-message greeting fallback
- **`cuibanHandler.js`**: Documented deliberate minimal session task shape `{ id, title }`
- **`feishu/client.js`**: Clarified reply-mode comment in `sendMessage`

---

## Documentation Updates

- `docs/architecture.md` — Updated main arch diagram, added AI agent section with tool descriptions, added `conversation_history` DB schema, updated env vars
- `docs/api.md` — Rewrote `/api/agent/*` section: updated `/status` response, added `/tasks` (GET/POST/complete) endpoints, updated Feishu bot command reference with AI natural language examples
- `CLAUDE.md` — Updated request flow diagram and `agentForwarder.js` module description
- `docs/edit-history/2026-02-28.md` — This file

---

## Files Modified

### Server
- `packages/server/src/services/agentForwarder.js` — Full rewrite (Anthropic tool calling)
- `packages/server/src/routes/webhook.js` — Empty text guard
- `packages/server/src/db/users.js` — `list()` idx fix
- `packages/server/src/db/index.js` — `audit.list()` idx fix
- `packages/server/src/routes/agent.js` — Status/schema endpoint fixes
- `packages/server/src/utils/intentDetector.js` — Order comment
- `packages/server/src/services/cuibanHandler.js` — Session shape comment
- `packages/server/src/feishu/client.js` — Reply mode comment

### Docs
- `docs/architecture.md`
- `docs/api.md`
- `CLAUDE.md`
