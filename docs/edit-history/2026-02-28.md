# Edit History — 2026-02-28

## Summary

Two major sessions today:

1. **AI Architecture Pivot** — Replaced OpenClaw agent forwarding with direct Anthropic API integration (tool calling pattern). agentForwarder.js now calls Claude directly, executes DB operations via tool executor, and replies via Feishu API without any relay.

2. **Code Review + Bug Fixes** — Full review of all server-side code; fixed security issue, edge cases, and code quality problems.

---

## AI Architecture: Direct Anthropic Tool Calling

### What Changed
- **`agentForwarder.js`** — Complete rewrite. No longer POSTs to `AGENT_WEBHOOK_URL`. Now:
  - Calls Anthropic API directly (`claude-haiku-4-5-20251001`)
  - Provides 3 tools: `list_tasks`, `create_task`, `complete_task`
  - Runs agentic loop (max 5 rounds) until `stop_reason = end_turn`
  - Persists conversation history in PostgreSQL (`conversation_history` table, 20 msgs/chat)
  - Builds system prompt with current date, user context, registered users list, and tool rules
  - Calls `feishu.sendMessage()` directly to reply
- **`AGENT_WEBHOOK_URL`** — No longer used; can be removed from `.env`
- **New env var**: `ANTHROPIC_API_KEY` (required for AI features)

### Why
- OpenClaw agent tool restriction (`tools.allow`) doesn't work for non-sandbox sessions
- Docker sandbox was blocked by systemd user service + docker GID issue
- Direct Anthropic API is more controllable and engineering-friendly

---

## Code Review Fixes (Session 1 — earlier today)

### Security
- **`agentForwarder.js`**: Added `complete_task` ownership check — users can only complete tasks assigned to themselves via chat. Queries DB before calling `completeTask()`, verifies `assignee_open_id` or `assignee_id` matches caller.

### Bug Fixes
- **`agentForwarder.js`**: Added fallback message when agentic loop exits with no text (e.g. `MAX_TOOL_ROUNDS` hit mid-tool-call) — previously silently dropped the request
- **`webhook.js`**: Added guard to skip AI forwarding when `messageText` is empty (non-text message types, parse failures) — prevented sending empty strings to Anthropic
- **`agentForwarder.js`**: Fixed `getAgentConfig()` — was returning `{ model }` but caller checked `config?.webhookUrl` → always `false`; now returns `{ model, maxHistoryMessages, maxToolRounds }`
- **`agent.js`** `/status`: Fixed `webhook_configured` field that was always `false` — replaced with actual config fields
- **`agent.js`** `/schema`: Removed references to `agentForwarder.BRIDGE_VERSION` and `CAPABILITIES` which were never exported (returned `undefined`)

### Code Quality
- **`users.js`** `list()`: Fixed `LIMIT $${idx++} OFFSET $${idx}` — relied on side-effect evaluation order; now explicit `limitIdx`/`offsetIdx`
- **`db/index.js`** `audit.list()`: Same `idx++` fix
- **`intentDetector.js`**: Added order-dependency comment — cuiban patterns must precede short-message greeting fallback
- **`cuibanHandler.js`**: Documented deliberate minimal session task shape `{ id, title }`
- **`feishu/client.js`**: Clarified reply-mode comment in `sendMessage`

---

## Comprehensive Code Review Fixes (Session 2)

Full codebase code review followed by "fix all" — 12 tracked issues resolved.

### Critical Fixes

1. **Singleton Anthropic client** (`agentForwarder.js`) — Replaced per-request `new Anthropic()` with lazy singleton `getClient()`. Avoids redundant object allocation and makes API key changes require a restart (acceptable trade-off).

2. **Migration for `conversation_history`** — Moved runtime DDL (`ensureConversationHistory`) from `db/index.js` + `index.js` startup into proper migration file `db/migrations/008_add_conversation_history.sql`. Removed the auto-DDL code path entirely.

3. **Atomic history pruning** (`agentForwarder.js`) — Replaced separate `INSERT` + `DELETE` with a single CTE query to prevent race conditions when concurrent messages arrive for the same chat.

4. **Concurrency backpressure** (`agentForwarder.js`) — Added semaphore pattern (`MAX_CONCURRENT_AGENTS=10`) with `acquireSlot()`/`releaseSlot()` wrapped in `try/finally` to prevent unbounded Anthropic API calls under load.

### Security Fixes

5. **Removed deprecated `requireAdmin`** (`auth.js`) — Deleted the function that read forgeable `x-user-id`/`x-user-email` headers. Removed from exports and tests.

6. **Agent task completion ownership check** (`agent.js`) — Added DB query to verify that `user_open_id` matches the task's `assignee_open_id` or `assignee_id` before allowing completion via `/api/agent/tasks/:id/complete`. Returns 403 on mismatch.

### Bug Fixes

7. **SQL interval injection** (`reminder.js`) — Replaced string concatenation `(reminder_interval_hours || ' hours')::interval` with parameterized `make_interval(hours => reminder_interval_hours)`.

8. **Field component prop injection** (`web/users/page.tsx`) — Replaced broken object spread `{...children, props: {id}}` with `React.cloneElement(children, { id })`.

9. **Dashboard `builtinEnabled`** (`api.js`) — Added missing `builtinEnabled` field to `/api/dashboard` response (was computed but not returned).

10. **`validateEnv.js`** — Replaced stale `AGENT_WEBHOOK_URL` references with `ANTHROPIC_API_KEY` in optional vars list and warning messages.

### Code Quality

11. **Batch rate limiter eviction** (`rateLimit.js`) — Changed single-entry eviction to batch ~10% eviction when hitting the 10k cap, reducing O(n) worst-case churn.

12. **Documentation comments** — Token expiry safety margin in `feishu/client.js`; `resolveActor` TODO in `api.js` noting client-provided userId is trusted pre-auth.

### Test Updates

- Removed `requireAdmin` test block from `auth.test.js`
- Updated `agent.test.js` mock for `agentForwarder` (new export shape)
- Rewrote `agentForwarder.test.js` — replaced stale OpenClaw-era tests (`formatForAgent`, `generateSignature`, `forwardToAgent`, `BRIDGE_VERSION`, `CAPABILITIES`) with tests for current exports (`isAgentConfigured`, `getAgentConfig`, `forwardToOwnerAgent`)

---

## Documentation Updates

### Session 1
- `docs/architecture.md` — Updated main arch diagram, added AI agent section with tool descriptions, added `conversation_history` DB schema, updated env vars
- `docs/api.md` — Rewrote `/api/agent/*` section: updated `/status` response, added `/tasks` (GET/POST/complete) endpoints, updated Feishu bot command reference with AI natural language examples
- `CLAUDE.md` — Updated request flow diagram and `agentForwarder.js` module description
- `docs/edit-history/2026-02-28.md` — This file

### Session 2
- `docs/architecture.md` — Removed `requireAdmin` reference from auth.js description; updated `conversation_history` note about migration; added concurrency semaphore to agentForwarder description; updated migration list with 008
- `docs/api.md` — Added 403 error for agent task completion ownership check; added `builtinEnabled` to dashboard response
- `docs/setup-openclaw.md` — Added deprecation notice (OpenClaw integration replaced by direct Anthropic API)
- `docs/troubleshooting.md` — Updated OpenClaw references with Anthropic context
- `CLAUDE.md` — Updated auth.js description (removed `requireAdmin`); updated migration count; updated `agentForwarder.js` description with concurrency semaphore

---

## Files Modified

### Server
- `packages/server/src/services/agentForwarder.js` — Full rewrite (Anthropic tool calling) + singleton client + atomic CTE pruning + concurrency semaphore
- `packages/server/src/routes/webhook.js` — Empty text guard
- `packages/server/src/routes/agent.js` — Status/schema endpoint fixes + ownership check on task completion
- `packages/server/src/routes/api.js` — Dashboard `builtinEnabled` + `resolveActor` TODO
- `packages/server/src/db/users.js` — `list()` idx fix
- `packages/server/src/db/index.js` — `audit.list()` idx fix + removed `ensureConversationHistory`
- `packages/server/src/index.js` — Removed `ensureConversationHistory` startup call
- `packages/server/src/middleware/auth.js` — Removed deprecated `requireAdmin`
- `packages/server/src/middleware/rateLimit.js` — Batch eviction (~10%)
- `packages/server/src/services/reminder.js` — `make_interval` fix
- `packages/server/src/utils/validateEnv.js` — ANTHROPIC_API_KEY references
- `packages/server/src/utils/intentDetector.js` — Order comment
- `packages/server/src/services/cuibanHandler.js` — Session shape comment
- `packages/server/src/feishu/client.js` — Token expiry comment + reply mode comment

### Web
- `packages/web/src/app/users/page.tsx` — `cloneElement` fix for Field component

### Tests
- `packages/server/tests/auth.test.js` — Removed `requireAdmin` block
- `packages/server/tests/agent.test.js` — Updated mock + assertions for new API shape
- `packages/server/tests/agentForwarder.test.js` — Full rewrite for current exports

### Database
- `db/migrations/008_add_conversation_history.sql` — New migration (moved from runtime DDL)

### Docs
- `docs/architecture.md`
- `docs/api.md`
- `docs/setup-openclaw.md`
- `docs/troubleshooting.md`
- `CLAUDE.md`
