# Edit History - 2026-02-26

## Session 3: Full Code Review Audit

Comprehensive code review across all 4 areas (server, web, tests, infrastructure). No code changes — audit only. Identified 29 issues (5 critical, 15 warning, 9 suggestion).

### Critical Findings

- **Client-side auth bypass** (`auth.tsx:9,25`): Admin password embedded in JS bundle via `NEXT_PUBLIC_ADMIN_PASSWORD`; auth state is a `localStorage` boolean — trivially bypassable. Known TODO.
- **API key in client bundle** (`api.ts:120`): `NEXT_PUBLIC_API_KEY` inlined by Next.js, extractable from DevTools. Known TODO.
- **React Hooks violation** (`tasks/page.tsx:38-39`): `useMemo` called after early returns (`if (isLoading) return`), violates Rules of Hooks — can crash at runtime.
- **Dev auth skip too broad** (`auth.js:69-71`): `NODE_ENV=development` skips all API auth; combined with CORS `*` fallback, staging could be open.
- **`init.sql` missing `feishu_user_id`**: Users table in `init.sql` lacks `feishu_user_id VARCHAR(64)` — fresh DB from init.sql alone will crash.

### Warning Findings

- Webhook signature bypass when `FEISHU_ENCRYPT_KEY` unset (non-production)
- No timestamp freshness check on webhook signatures (replay after 5-min dedup expires)
- Error handler doesn't check `res.headersSent`
- Rate limiter single-entry eviction easily defeated
- No log file retention/rotation policy
- Shutdown has no timeout (hangs forever if pool.end() stalls)
- `new URL()` can throw on malformed `AGENT_WEBHOOK_URL`
- Broken `Field` component child cloning in `users/page.tsx` (uses spread instead of `React.cloneElement`)
- `className="input"` in modals has no corresponding CSS class
- Missing ARIA `aria-controls`/`aria-activedescendant` on UserCombobox
- Login rate limiting state lost on page refresh
- Hardcoded Feishu base URL (no Lark International support)
- Intent detector treats messages <=6 chars as greetings (too aggressive for Chinese)
- Next.js 14.1.0 has known CVEs; Express 4.18.2 has patches through 4.21.x
- Missing CHECK constraints on `tasks.status`, `users.role`, `admins.role`

### Test Coverage Gaps

- **Zero tests:** `webhook.js`, `cuibanHandler.js`, `intentDetector.js`, `users.js` route, `feishu/client.js`, `db/users.js`, `rateLimit.js`
- **Web:** Only 1 trivial test (`components.test.tsx`) — entire frontend effectively untested
- **`POST /api/tasks`**: Most complex route, entirely untested
- **`db.test.js`**: All tests skipped when `NODE_ENV=test` (always in Jest) — provides zero coverage
- **No error-path testing** across any route tests

### Schema Issues

- `init.sql` duplicate `user_sessions` block (lines 67-76 and 81-90)
- `init.sql` missing indexes from migrations 005/007 (`tasks_reminder_idx`, `tasks_overdue_idx`)
- Redundant `user_sessions_key_idx` (UNIQUE already creates index)
- No migration tracking mechanism (`schema_migrations` table)
- No down migrations

---

## Session 2: Comprehensive Code Review Fix-All (45 issues)

Full code review identified 45 issues (6 critical, 20 warning, 19 suggestion) across server, web, tests, and config. All 45 fixed, 110 server tests passing, TypeScript clean.

### Critical Fixes

- **Webhook signature over raw body**: `express.json({ verify })` preserves raw body as Buffer; signature verification now uses raw bytes instead of re-serialized JSON (prevents key-ordering mismatch)
- **`requireAdmin` marked deprecated**: Added `@deprecated` JSDoc + runtime `logger.warn` on every call — middleware reads identity from forgeable `x-user-id`/`x-user-email` headers
- **Rate limiter memory bound**: Added `MAX_RATE_LIMIT_ENTRIES = 10000` cap with oldest-entry eviction to prevent unbounded memory growth
- **Rate limiter off-by-one**: Changed `> maxRequests` to `>= maxRequests`
- **Feishu token retry-on-401**: `request()` now retries once after clearing token cache on HTTP 401 (handles token expiry race)
- **`redactedUrl` scope fix**: Moved URL redaction outside try block in `agentForwarder.forwardToAgent()` so catch block can access it

### Security Improvements

- **Settings key whitelist**: `PUT /settings/:key` now validates against `VALID_SETTING_KEYS` array — prevents arbitrary key injection
- **Role validation on user creation**: `POST /users` validates `role` against `['superadmin', 'admin', 'user']`
- **Admin role validation**: `admins.add()` validates against `['admin', 'superadmin']`
- **Guard clause**: `admins.isAdmin()` returns false early when both userId and email are null
- **Error message sanitization**: Removed userId from "User not found" errors in all 4 `db/users.js` throw sites
- **Security comment**: Added critical security gate documentation to `setFeature` regex guard

### Server Improvements

- **Body size limit**: `express.json({ limit: '1mb' })` prevents oversized payloads
- **Shutdown error handling**: SIGTERM/SIGINT handlers now catch promise rejections
- **4xx log level**: `logger.js` now logs 4xx as `warn` instead of `error` (5xx stays `error`)
- **validateEnv**: Added `CORS_ORIGIN` and `REQUIRE_AUTH` to optional env vars
- **sendCardMessage**: Added `data.code` error check (was missing, unlike `sendMessage`)
- **agent.js detectIdType**: Throws Error on null id instead of defaulting silently
- **agent.js content logging**: Fixed content length calculation for non-string content
- **reminder.js date validation**: Strict YYYY-MM-DD parsing with `T00:00:00` suffix to avoid timezone shift
- **cuibanHandler.js session data**: Sessions now store only `{id, title}` per task instead of full DB rows

### Web Frontend

- **api.ts**: `Content-Type: application/json` only set when request has body; proper `Record<string, string>` header type
- **auth.tsx**: Login rate limiting — 5 attempts max, 1-minute lockout after exhaustion
- **page.tsx**: Responsive grid (`md:grid-cols-2` when builtinEnabled=false); timezone-aware date formatting
- **tasks/page.tsx**: `useMemo` for pending/completed counts; `aria-label` on complete/delete buttons
- **users/page.tsx**: Modal scroll lock (`body.overflow = hidden`); `aria-label` on role select; `Field` component label association via `htmlFor`/`useId`; scroll lock cleanup on unmount
- **UserCombobox.tsx**: `SelectableUser` type narrowing (openId guaranteed non-null); keyboard navigation (ArrowUp/Down/Enter/Escape); combobox ARIA roles (`role="combobox"`, `role="listbox"`, `role="option"`); removed redundant hidden input
- **StatusStates.tsx**: `aria-hidden="true"` on decorative spinner; `onRetry` callback prop alongside `retryKey`

### Tests Added/Updated

- **reminder.test.js**: Invalid deadline rejection test, YYYY-MM-DD format acceptance, Part 2 rollback test
- **agentForwarder.test.js**: `forwardToAgent` fetch mock tests (success, non-OK response, abort timeout)
- **auth.test.js**: `requireAdmin` tests (no headers → 401, non-admin → 403, admin → passthrough + adminUser attachment, deprecation warning logged)
- **api.test.js**: Settings key whitelist validation (rejects unknown keys, accepts valid keys)

### Config

- **.env.example**: Fixed password mismatch (`your_secure_password_here` → `your_secure_password` to match `DATABASE_URL`)
- **docker-compose.yml**: Added missing server env vars (`FEISHU_ENCRYPT_KEY`, `AGENT_WEBHOOK_URL`, `AGENT_API_KEY`, `AGENT_TIMEOUT_MS`, `ENABLE_BUILTIN_BOT`, `API_BASE_URL`, `LOG_LEVEL`); added web build args for `NEXT_PUBLIC_ADMIN_PASSWORD` and `NEXT_PUBLIC_API_KEY`

---

## Session 1: Security Hardening + Code Quality

Security hardening and code quality session. Two rounds of code review identified 27+ issues across 35 files. All issues fixed, 100 tests passing, web build clean.

### Changes by Category

#### Security Hardening

- **Auth bypass tightened**: API auth now only skips in explicit `NODE_ENV=development`; all other envs (test, staging, etc.) reject requests when `API_KEY` is unset
- **Timing side-channel fix**: API key comparison uses SHA-256 hash + `crypto.timingSafeEqual` to prevent both length and timing attacks
- **Encrypted payload guard**: Feishu webhook encrypted bypass only activates when `FEISHU_ENCRYPT_KEY` is configured
- **Token error sanitization**: Feishu client no longer logs full token response body (prevents secret leakage)
- **Production error masking**: User-facing routes use `safeErrorMessage()` to hide internal details in production
- **CORS restriction**: Added `CORS_ORIGIN` env var support with production warning in `validateEnv.js`
- **Docker hardening**: Removed default password, ports bound to 127.0.0.1, `NODE_ENV=production` set, health checks added

#### Bug Fixes

- **SWR cache key mismatch**: Created `SWR_KEYS` constants in `api.ts`, applied across all 3 pages and `mutate()` calls
- **deleteTask body vs query**: Fixed frontend to send `userId` as query parameter (matching server API)
- **Negative reminder interval**: Server now clamps `reminderIntervalHours` to `>= 0` with `Math.floor`
- **completeTask race**: Added `AND status = 'pending'` guard to prevent double-completion
- **Token refresh floor**: Changed minimum token TTL from 0 to 300 seconds to prevent refresh loops
- **Feishu client init**: Moved APP_ID/APP_SECRET reads into `getToken()` with missing-var guard
- **Logger mkdirSync**: Wrapped in try/catch to prevent crash on read-only filesystem

#### Input Validation

- Task title max 200 characters, note max 1000 characters (server-side)
- Invalid (non-numeric) task IDs return 400 instead of 500
- Deadline date validation (reject Invalid Date)

#### Accessibility

- Added `aria-label` to loading spinner
- Created `useFocusTrap` hook for modal dialogs (Tab cycling + Escape)
- Applied focus trap to EditUserModal and AddUserModal

#### Frontend Improvements

- `UserCombobox`: Filters out users without `openId` via `useMemo`
- `users/page.tsx`: Loading guard on delete, extracted `ResetOverridesButton` component
- `StatusStates.tsx`: Shared loading/error/empty components with ARIA roles
- `api.ts`: AbortController with 15s timeout, content-type validation

#### Docker & Infrastructure

- Removed deprecated `version: '3.8'` from docker-compose.yml
- PostgreSQL password required via `${POSTGRES_PASSWORD:?}` syntax
- Added health checks for all 3 services (pg_isready, Node.js fetch)
- Service startup order via `condition: service_healthy`
- Added `API_KEY` and `CORS_ORIGIN` passthrough to server environment

#### Documentation

- Rewrote `CLAUDE.md` with updated modules, auth conventions, web patterns
- Rewrote `docs/api.md` with validation rules, auth behavior, error codes
- Updated `docs/architecture.md` package structure, security table, Docker section

## Files Modified (Cumulative)

### Server
- `packages/server/src/index.js` — body size limit, raw body preservation, shutdown error handling
- `packages/server/src/middleware/auth.js` — raw body signature, requireAdmin deprecated, timing-safe comparison
- `packages/server/src/middleware/rateLimit.js` — memory cap, off-by-one fix
- `packages/server/src/routes/api.js` — settings key whitelist, title/note validation, interval clamping
- `packages/server/src/routes/agent.js` — detectIdType throws on null, content length fix
- `packages/server/src/routes/users.js` — role validation on POST/PATCH
- `packages/server/src/routes/webhook.js` — cuibanHandler extraction, dedup comment
- `packages/server/src/services/reminder.js` — date validation, completeTask status guard, deadline alert cron
- `packages/server/src/services/agentForwarder.js` — URL redaction, error truncation, redactedUrl scope fix
- `packages/server/src/services/cuibanHandler.js` — **NEW** extracted from webhook.js
- `packages/server/src/feishu/client.js` — retry-on-401, sendCardMessage error check, token init guard
- `packages/server/src/db/index.js` — isAdmin guard clause, admin role validation
- `packages/server/src/db/users.js` — security comment, sanitized errors
- `packages/server/src/db/sessions.js` — minor update
- `packages/server/src/utils/logger.js` — 4xx warn level, mkdirSync try/catch
- `packages/server/src/utils/validateEnv.js` — optional vars expanded
- `packages/server/src/utils/safeError.js` — **NEW** production error masking

### Tests
- `packages/server/tests/auth.test.js` — **NEW** full auth middleware test suite + requireAdmin tests
- `packages/server/tests/features.test.js` — **NEW** feature/permission module tests
- `packages/server/tests/reminder.test.js` — **NEW** reminder service tests + invalid deadline + rollback
- `packages/server/tests/agentForwarder.test.js` — forwardToAgent fetch tests
- `packages/server/tests/api.test.js` — settings whitelist tests

### Web
- `packages/web/src/lib/api.ts` — Content-Type fix, SWR_KEYS, AbortController, type safety
- `packages/web/src/lib/auth.tsx` — login rate limiting
- `packages/web/src/app/page.tsx` — responsive grid, timezone dates
- `packages/web/src/app/tasks/page.tsx` — useMemo, aria-labels
- `packages/web/src/app/users/page.tsx` — scroll lock, aria-label, Field label association
- `packages/web/src/components/UserCombobox.tsx` — type narrowing, keyboard nav, ARIA
- `packages/web/src/components/StatusStates.tsx` — **NEW** shared states with a11y

### Config & Docs
- `.env.example` — password consistency, NEXT_PUBLIC vars
- `docker-compose.yml` — missing env vars, web build args, health checks, security
- `CLAUDE.md` — full rewrite
- `docs/api.md` — settings whitelist, validation rules, auth behavior
- `docs/architecture.md` — security table, Docker section, package structure
